test_run = require('test_run').new()
---
...
test_run:cmd("push filter '.*/init.lua.*[0-9]+: ' to ''")
---
- true
...
netbox = require('net.box')
---
...
fiber = require('fiber')
---
...
REPLICASET_1 = { 'storage_1_a', 'storage_1_b' }
---
...
REPLICASET_2 = { 'storage_2_a', 'storage_2_b' }
---
...
test_run:create_cluster(REPLICASET_1, 'main')
---
...
test_run:create_cluster(REPLICASET_2, 'main')
---
...
test_run:wait_fullmesh(REPLICASET_1)
---
...
test_run:wait_fullmesh(REPLICASET_2)
---
...
test_run:cmd("create server router_1 with script='main/router_1.lua'")
---
- true
...
test_run:cmd("start server router_1")
---
- true
...
-- Break a connection to a master.
_ = test_run:cmd('stop server storage_1_a')
---
...
_ = test_run:switch('router_1')
---
...
reps = vshard.router.internal.replicasets
---
...
test_run:cmd("setopt delimiter ';'")
---
- true
...
function is_disconnected()
    for i, rep in pairs(reps) do
        if rep.master.conn == nil or rep.master.conn.state ~= 'active' then
            return true
        end
    end
    return false
end
test_run:cmd("setopt delimiter ''");
---
...
-- No master in replica set 1.
is_disconnected()
---
- true
...
-- Wait until replica is connected to test alerts on unavailable
-- master.
fiber = require('fiber')
---
...
while vshard.router.internal.replicasets[replicasets[1]].replica == nil do fiber.sleep(0.1) end
---
...
vshard.router.info()
---
- replicasets:
    ac522f65-aa94-4134-9f64-51ee384f1a54:
      replica:
        status: available
        uri: storage:storage@127.0.0.1:3303
        uuid: 1e02ae8a-afc0-4e91-ba34-843a356b8ed7
      uuid: ac522f65-aa94-4134-9f64-51ee384f1a54
      master:
        status: available
        uri: storage:storage@127.0.0.1:3303
        uuid: 1e02ae8a-afc0-4e91-ba34-843a356b8ed7
    cbf06940-0790-498b-948d-042b62cf3d29:
      replica:
        status: available
        uri: storage:storage@127.0.0.1:3302
        uuid: 3de2e3e1-9ebe-4d0d-abb1-26d301b84633
      uuid: cbf06940-0790-498b-948d-042b62cf3d29
      master:
        status: unreachable
        uri: storage:storage@127.0.0.1:3301
        uuid: 8a274925-a26d-47fc-9e1b-af88ce939412
  status: 2
  alerts:
  - ['UNREACHABLE_MASTER', 'Master of replicaset cbf06940-0790-498b-948d-042b62cf3d29
      is unreachable: disconnected']
  - ['SUBOPTIMAL_REPLICA', 'A current read replica in replicaset cbf06940-0790-498b-948d-042b62cf3d29
      is not optimal']
...
-- Return master.
_ = test_run:cmd('start server storage_1_a')
---
...
fiber = require('fiber')
---
...
max_iters = 1000
---
...
i = 0
---
...
while is_disconnected() and i < max_iters do i = i + 1 fiber.sleep(0.1) end
---
...
-- Master connection is active again.
is_disconnected()
---
- false
...
_ = test_run:cmd("switch default")
---
...
test_run:cmd('stop server router_1')
---
- true
...
test_run:cmd('cleanup server router_1')
---
- true
...
test_run:drop_cluster(REPLICASET_2)
---
...
test_run:drop_cluster(REPLICASET_1)
---
...
