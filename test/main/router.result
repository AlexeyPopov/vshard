test_run = require('test_run').new()
---
...
test_run:cmd("push filter '.*/init.lua.*[0-9]+: ' to ''")
---
- true
...
netbox = require('net.box')
---
...
fiber = require('fiber')
---
...
REPLICASET_1 = { 'storage_1_a', 'storage_1_b' }
---
...
REPLICASET_2 = { 'storage_2_a', 'storage_2_b' }
---
...
test_run:create_cluster(REPLICASET_1, 'main')
---
...
test_run:create_cluster(REPLICASET_2, 'main')
---
...
test_run:wait_fullmesh(REPLICASET_1)
---
...
test_run:wait_fullmesh(REPLICASET_2)
---
...
test_run:cmd("create server router_1 with script='main/router_1.lua'")
---
- true
...
test_run:cmd("start server router_1")
---
- true
...
replicaset1_uuid = test_run:eval('storage_1_a', 'box.info.cluster.uuid')[1]
---
...
replicaset2_uuid = test_run:eval('storage_2_a', 'box.info.cluster.uuid')[1]
---
...
test_run:cmd("push filter '"..replicaset1_uuid.."' to '<replicaset_1>'")
---
- true
...
test_run:cmd("push filter '"..replicaset2_uuid.."' to '<replicaset_2>'")
---
- true
...
_ = test_run:cmd("switch router_1")
---
...
--
-- Initial distribution
--
replicaset, err = vshard.router.bucket_discovery(1); return err == nil or err
---
- code: 2
  bucket_id: 1
...
vshard.router.bootstrap()
---
...
replicaset, err = vshard.router.bucket_discovery(1); return err == nil or err
---
- true
...
replicaset, err = vshard.router.bucket_discovery(2); return err == nil or err
---
- true
...
--
-- Function call
--
bucket_id = 1
---
...
test_run:cmd("setopt delimiter ';'")
---
- true
...
customer = {
    customer_id = 1,
    name = "Customer 1",
    bucket_id = bucket_id,
    accounts = {
        {
            account_id = 10,
            name = "Credit Card",
            balance = 100,
        },
        {
            account_id = 11,
            name = "Debit Card",
            balance = 50,
        },
    }
}
test_run:cmd("setopt delimiter ''");
---
...
vshard.router.call(bucket_id, 'write', 'customer_add', {customer})
---
- true
...
vshard.router.call(bucket_id, 'read', 'customer_lookup', {1})
---
- {'accounts': [{'account_id': 10, 'balance': 0, 'name': 'Credit Card'}, {'account_id': 11,
      'balance': 0, 'name': 'Debit Card'}], 'customer_id': 1, 'name': 'Customer 1'}
...
vshard.router.call(bucket_id + 1, 'read', 'customer_lookup', {1}) -- nothing
---
- null
...
--
-- Monitoring
--
vshard.router.info().replicasets[1].master.state
---
- active
...
vshard.router.info().replicasets[2].master.state
---
- active
...
--
-- Configuration: inconsistency master=true on storage and routers
--
-- This test case flips masters in replicasets without changing
-- configuration on router and tests NON_MASTER response
--
-- Test the WRITE request
vshard.router.call(1, 'write', 'echo', { 'hello world' })
---
- hello world
...
-- Shuffle masters
util = require('util')
---
...
util.shuffle_masters(cfg)
---
...
-- Reconfigure storages
test_run:cmd("switch storage_1_a")
---
- true
...
cfg.sharding = test_run:eval('router_1', 'return cfg.sharding')[1]
---
...
vshard.storage.cfg(cfg, names['storage_1_a'])
---
...
test_run:cmd("switch storage_1_b")
---
- true
...
cfg.sharding = test_run:eval('router_1', 'return cfg.sharding')[1]
---
...
vshard.storage.cfg(cfg, names['storage_1_b'])
---
...
test_run:cmd("switch storage_2_a")
---
- true
...
cfg.sharding = test_run:eval('router_1', 'return cfg.sharding')[1]
---
...
vshard.storage.cfg(cfg, names['storage_2_a'])
---
...
test_run:cmd("switch storage_2_b")
---
- true
...
cfg.sharding = test_run:eval('router_1', 'return cfg.sharding')[1]
---
...
vshard.storage.cfg(cfg, names['storage_2_b'])
---
...
-- Test that the WRITE request doesn't work
test_run:cmd("switch router_1")
---
- true
...
util.check_error(vshard.router.call, 1, 'write', 'echo', { 'hello world' })
---
- Can't found master for <replicaset_2>
...
-- Reconfigure router and test that the WRITE request does work
vshard.router.cfg(cfg)
---
...
vshard.router.call(1, 'write', 'echo', { 'hello world' })
---
- hello world
...
_ = test_run:cmd("switch default")
---
...
test_run:cmd("stop server router_1")
---
- true
...
test_run:cmd("cleanup server router_1")
---
- true
...
test_run:drop_cluster(REPLICASET_2)
---
...
test_run:drop_cluster(REPLICASET_1)
---
...
test_run:cmd('clear filter')
---
- true
...
